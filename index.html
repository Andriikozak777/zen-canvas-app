<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∑–µ–Ω-–•–æ–ª—Å—Ç: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –£–ª—É—á—à–µ–Ω–Ω–∞—è –í–µ—Ä—Å–∏—è</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js">
    let mediaRecorder;
    let recordedChunks = [];

    const recordButton = document.createElement('button');
    recordButton.id = "recordButton";
    recordButton.className = "action-button";
    recordButton.style.background = "linear-gradient(145deg, #f56565, #c53030)";
    recordButton.textContent = translations[currentLanguage].recordStart;
    controlsPanel.appendChild(recordButton);

    recordButton.addEventListener('click', () => {
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            startRecording();
            recordButton.textContent = translations[currentLanguage].recordStop;
        } else if (mediaRecorder.state === "recording") {
            stopRecording();
            recordButton.textContent = translations[currentLanguage].recordStart;
        }
    });

    function startRecording() {
        const stream = canvas.captureStream(30);
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });

        mediaRecorder.ondataavailable = e => {
            if (e.data.size > 0) recordedChunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'zen-canvas-recording.webm';
            a.click();
            URL.revokeObjectURL(url);
            recordedChunks = [];
        };

        mediaRecorder.start();
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
        }
    }

</script>
    <script src="https://cdn.tailwindcss.com">
    let mediaRecorder;
    let recordedChunks = [];

    const recordButton = document.createElement('button');
    recordButton.id = "recordButton";
    recordButton.className = "action-button";
    recordButton.style.background = "linear-gradient(145deg, #f56565, #c53030)";
    recordButton.textContent = translations[currentLanguage].recordStart;
    controlsPanel.appendChild(recordButton);

    recordButton.addEventListener('click', () => {
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            startRecording();
            recordButton.textContent = translations[currentLanguage].recordStop;
        } else if (mediaRecorder.state === "recording") {
            stopRecording();
            recordButton.textContent = translations[currentLanguage].recordStart;
        }
    });

    function startRecording() {
        const stream = canvas.captureStream(30);
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });

        mediaRecorder.ondataavailable = e => {
            if (e.data.size > 0) recordedChunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'zen-canvas-recording.webm';
            a.click();
            URL.revokeObjectURL(url);
            recordedChunks = [];
        };

        mediaRecorder.start();
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
        }
    }

</script>
    <style>
        /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Ç–µ–º–Ω–∞—è —Ç–µ–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            color: white;
            background-color: #000;
            position: relative;
            cursor: default;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ö–æ–ª—Å—Ç–∞ */
        canvas {
            display: block;
            background-color: #000;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            touch-action: none;
            transition: background-color 0.5s ease;
        }

        /* –ù–∞–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è –∏ —Ç–µ–∫—Å—Ç–∞ */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            text-align: center;
            z-index: 10;
            opacity: 1;
            transition: opacity 1.5s ease-out, background-color 0.5s ease;
        }

        .overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ —Ç–µ–∫—Å—Ç–∞ –≤ –æ–≤–µ—Ä–ª–µ–µ */
        .overlay h1, .overlay p {
            color: white;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            transition: color 0.5s ease, text-shadow 0.5s ease;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–°—Ç–∞—Ä—Ç" */
        .start-button {
            background-color: #4CAF50;
            color: white;
            padding: 1rem 2.5rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .start-button:hover {
            background-color: #45a049;
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        }

        .start-button:active {
            background-color: #3e8e41;
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Ç–µ–ø–µ—Ä—å —ç—Ç–æ –±–æ–∫–æ–≤–æ–µ –º–µ–Ω—é) */
        .controls-panel {
            position: fixed; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ */
            top: 0;
            left: 0;
            height: 100vh; /* –ü–æ–ª–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —ç–∫—Ä–∞–Ω–∞ */
            width: 320px; /* –®–∏—Ä–∏–Ω–∞ –º–µ–Ω—é */
            max-width: 80vw; /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            background: rgba(45, 55, 72, 0.9); /* –ë–æ–ª–µ–µ –ø–ª–æ—Ç–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –º–µ–Ω—é */
            backdrop-filter: blur(10px); /* –£—Å–∏–ª–µ–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç —Ä–∞–∑–º—ã—Ç–∏—è */
            -webkit-backdrop-filter: blur(10px);
            padding-top: 4rem; /* –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è */
            padding-bottom: 1.8rem;
            padding-left: 1.8rem;
            padding-right: 1.8rem;
            border-radius: 0 1.2rem 1.2rem 0; /* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å–ø—Ä–∞–≤–∞ */
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.5);
            border-right: 1px solid rgba(100, 116, 139, 0.3); /* –ì—Ä–∞–Ω–∏—Ü–∞ —Å–ø—Ä–∞–≤–∞ */
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transform: translateX(-100%); /* –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–æ —Å–ª–µ–≤–∞ */
            transition: transform 0.3s ease-in-out, background-color 0.5s ease, border-color 0.5s ease;
            overflow-y: auto; /* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–ª—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ */
        }

        .controls-panel.visible {
            transform: translateX(0); /* –í—ã–¥–≤–∏–≥–∞–µ—Ç—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω */
        }

        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–æ—Å—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è Webkit-–±—Ä–∞—É–∑–µ—Ä–æ–≤ */
        .controls-panel::-webkit-scrollbar {
            width: 8px;
        }

        .controls-panel::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .controls-panel::-webkit-scrollbar-thumb {
            background: #63b3ed;
            border-radius: 10px;
            transition: background 0.3s ease;
        }

        .controls-panel::-webkit-scrollbar-thumb:hover {
            background: #4299e1;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            align-items: flex-start;
        }

        .control-group label {
            font-size: 1.05rem;
            color: #e2e8f0;
            font-weight: bold;
            margin-bottom: 0.15rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            transition: color 0.5s ease, text-shadow 0.5s ease;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–∑—É–Ω–∫–æ–≤ (input[type="range"]) */
        .control-group input[type="range"] {
            width: 100%;
            height: 12px;
            background: linear-gradient(to right, #63b3ed, #4299e1);
            outline: none;
            border-radius: 6px;
            opacity: 0.95;
            transition: opacity .2s, box-shadow .2s, background 0.5s ease;
            box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.4);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none;
        }

        .control-group input[type="range"]:hover {
            opacity: 1;
            box-shadow: inset 0 1px 6px rgba(0, 0, 0, 0.5);
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #a0aec0;
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
            border: 3px solid #4299e1;
            transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease, border-color 0.5s ease;
        }

        .control-group input[type="range"]::-webkit-slider-thumb:hover {
            background: #cbd5e0;
            transform: scale(1.15);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.5);
        }

        .control-group input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #a0aec0;
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
            border: 3px solid #4299e1;
            transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease, border-color 0.5s ease;
        }
        .control-group input[type="range"]::-moz-range-thumb:hover {
            background: #cbd5e0;
            transform: scale(1.15);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.5);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ (select) */
        .control-group select {
            width: 100%;
            height: 42px;
            background: #cbd5e0;
            outline: none;
            border-radius: 6px;
            opacity: 0.95;
            transition: opacity .2s, box-shadow .2s, background 0.5s ease, color 0.5s ease;
            color: #333;
            border: none;
            padding: 0.6rem 1rem;
            font-size: 1rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.6-6.4H19.4a17.6%2017.6%200%200%200-13.6%206.4%2017.6%2017.6%200%200%200%200%2025.3l128%20128a17.6%2017.6%200%200%200%2025.3%200l128-128c6.5-6.4%206.5-17.6%200-25.3z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.7em center;
            background-size: 0.9em auto;
            box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.4);
        }
        .control-group select:hover {
            opacity: 1;
            box-shadow: inset 0 1px 6px rgba(0, 0, 0, 0.5);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é/—Å–∫—Ä—ã—Ç–∏—è */
        .menu-toggle-button {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: linear-gradient(145deg, #63b3ed, #4299e1);
            color: white;
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 0.6rem;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease, color 0.5s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            z-index: 21;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .menu-toggle-button:hover {
            background: linear-gradient(145deg, #4299e1, #3182ce);
            transform: translateY(-3px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.4);
        }

        .menu-toggle-button:active {
            background: linear-gradient(145deg, #3182ce, #2b6cb0);
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π (–û—á–∏—Å—Ç–∏—Ç—å, –°–±—Ä–æ—Å–∏—Ç—å, –°–∫—Ä–∏–Ω—à–æ—Ç) */
        .action-button {
            background: linear-gradient(145deg, #e53e3e, #c53030);
            color: white;
            padding: 0.9rem 1.8rem;
            border: none;
            border-radius: 0.8rem;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease, color 0.5s ease;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
            margin-top: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .action-button:hover {
            background: linear-gradient(145deg, #c53030, #9b2c2c);
            transform: translateY(-3px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.4);
        }

        .action-button:active {
            background: linear-gradient(145deg, #9b2c2c, #7b1e1e);
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–±—Ä–æ—Å–∞ (–æ—Ç–ª–∏—á–Ω—ã–π —Ü–≤–µ—Ç) */
        .reset-button {
            background: linear-gradient(145deg, #f6e05e, #ecc94b);
            color: #333;
        }
        .reset-button:hover {
            background: linear-gradient(145deg, #ecc94b, #d69e2e);
            color: #222;
        }
        .reset-button:active {
            background: linear-gradient(145deg, #d69e2e, #b7791f);
            color: #111;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ */
        .screenshot-button {
            background: linear-gradient(145deg, #81e6d9, #4fd1c5);
            color: #333;
        }
        .screenshot-button:hover {
            background: linear-gradient(145deg, #4fd1c5, #38b2ac);
            color: #222;
        }
        .screenshot-button:active {
            background: linear-gradient(145deg, #38b2ac, #319795);
            color: #111;
        }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã --- */
        .theme-toggle-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: linear-gradient(145deg, #a0aec0, #cbd5e0); /* –°–≤–µ—Ç–ª—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
            color: #333; /* –¢–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç */
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 0.6rem;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease, color 0.5s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            z-index: 21;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .theme-toggle-button:hover {
            background: linear-gradient(145deg, #cbd5e0, #e2e8f0);
            transform: translateY(-3px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.4);
        }

        .theme-toggle-button:active {
            background: linear-gradient(145deg, #e2e8f0, #edf2f7);
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –ë–≠–ö–î–†–û–ü–ê –º–µ–Ω—é --- */
        .menu-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —á–µ—Ä–Ω—ã–π */
            z-index: 19; /* –ü–æ–¥ –º–µ–Ω—é, –Ω–æ –Ω–∞–¥ —Ö–æ–ª—Å—Ç–æ–º */
            opacity: 0;
            pointer-events: none; /* –ù–µ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ —Å–æ–±—ã—Ç–∏—è, –ø–æ–∫–∞ —Å–∫—Ä—ã—Ç */
            transition: opacity 0.3s ease-in-out;
        }

        .menu-backdrop.visible {
            opacity: 1;
            pointer-events: auto; /* –†–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ —Å–æ–±—ã—Ç–∏—è, –∫–æ–≥–¥–∞ –≤–∏–¥–∏–º */
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –≤ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        #gameInstructions {
            font-size: 0.9rem;
            color: #a0aec0;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 0.75rem;
            border-radius: 0.5rem;
            line-height: 1.4;
            margin-top: 0.5rem;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –°–í–ï–¢–õ–û–ô –¢–ï–ú–´ --- */
        body.light-theme {
            background-color: #f0f0f0;
            color: #333;
        }

        body.light-theme canvas {
            background-color: #e0e0e0;
        }

        body.light-theme .overlay {
            background-color: rgba(255, 255, 255, 0.8);
        }

        body.light-theme .overlay h1, body.light-theme .overlay p {
            color: #333;
            text-shadow: none;
        }

        body.light-theme .controls-panel {
            background: rgba(255, 255, 255, 0.9);
            border-right: 1px solid rgba(0, 0, 0, 0.2);
        }

        body.light-theme .controls-panel::-webkit-scrollbar-track {
            background: rgba(200, 200, 200, 0.5);
        }

        body.light-theme .controls-panel::-webkit-scrollbar-thumb {
            background: #a0aec0;
        }

        body.light-theme .control-group label {
            color: #333;
            text-shadow: none;
        }

        body.light-theme .control-group input[type="range"] {
            background: linear-gradient(to right, #cbd5e0, #e2e8f0);
            box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.2);
        }

        body.light-theme .control-group input[type="range"]::-webkit-slider-thumb {
            background: #4299e1;
            border-color: #63b3ed;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }
        body.light-theme .control-group input[type="range"]::-webkit-slider-thumb:hover {
            background: #3182ce;
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.3);
        }

        body.light-theme .control-group input[type="range"]::-moz-range-thumb {
            background: #4299e1;
            border-color: #63b3ed;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }
        body.light-theme .control-group input[type="range"]::-moz-range-thumb:hover {
            background: #3182ce;
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.3);
        }

        body.light-theme .control-group select {
            background: #e2e8f0;
            color: #333;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23cccccc%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.6-6.4H19.4a17.6%2017.6%200%200%200-13.6%206.4%2017.6%2017.6%200%200%200%200%2025.3l128%20128a17.6%2017.6%200%200%200%2025.3%200l128-128c6.5-6.4%206.5-17.6%200-25.3z%22%2F%3E%3C%2Fsvg%3E');
            box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.2);
        }
        body.light-theme .control-group select:hover {
            box-shadow: inset 0 1px 6px rgba(0, 0, 0, 0.3);
        }

        body.light-theme .menu-toggle-button {
            background: linear-gradient(145deg, #a0aec0, #cbd5e0);
            color: #333;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }
        body.light-theme .menu-toggle-button:hover {
            background: linear-gradient(145deg, #cbd5e0, #e2e8f0);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.3);
        }
        body.light-theme .menu-toggle-button:active {
            background: linear-gradient(145deg, #e2e8f0, #edf2f7);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        body.light-theme .action-button {
            background: linear-gradient(145deg, #63b3ed, #4299e1);
            color: white;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }
        body.light-theme .action-button:hover {
            background: linear-gradient(145deg, #4299e1, #3182ce);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.3);
        }
        body.light-theme .action-button:active {
            background: linear-gradient(145deg, #3182ce, #2b6cb0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        body.light-theme .reset-button {
            background: linear-gradient(145deg, #f6e05e, #ecc94b);
            color: #333;
        }
        body.light-theme .reset-button:hover {
            background: linear-gradient(145deg, #ecc94b, #d69e2e);
            color: #222;
        }
        body.light-theme .reset-button:active {
            background: linear-gradient(145deg, #d69e2e, #b7791f);
            color: #111;
        }

        body.light-theme .screenshot-button {
            background: linear-gradient(145deg, #81e6d9, #4fd1c5);
            color: #333;
        }
        body.light-theme .screenshot-button:hover {
            background: linear-gradient(145deg, #4fd1c5, #38b2ac);
            color: #222;
        }
        body.light-theme .screenshot-button:active {
            background: linear-gradient(145deg, #38b2ac, #319795);
            color: #111;
        }

        body.light-theme #gameInstructions {
            color: #333;
            background-color: rgba(200, 200, 200, 0.5);
        }

        /* –ú–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            p {
                font-size: 1rem;
                max-width: 90%;
            }
            .start-button {
                font-size: 1.1rem;
                padding: 0.8rem 2rem;
            }
            .controls-panel {
                width: 90vw; /* –ë–æ–ª—å—à–∞—è —á–∞—Å—Ç—å —ç–∫—Ä–∞–Ω–∞ */
                padding-top: 3rem; /* –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
                padding-bottom: 1rem;
                padding-left: 1rem;
                padding-right: 1rem;
                border-radius: 0 0 1.2rem 0; /* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞ */
            }
            .control-group {
                flex-direction: column; /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
                align-items: flex-start;
                gap: 0.3rem;
            }
            .control-group label {
                font-size: 0.9rem;
            }
            .control-group input[type="range"],
            .control-group select {
                width: 100%; /* –ü–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
                height: 8px;
            }
            .menu-toggle-button {
                top: 0.5rem;
                left: 0.5rem;
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            .action-button {
                padding: 0.6rem 1.2rem;
                font-size: 0.95rem;
            }
            .theme-toggle-button {
                top: 0.5rem;
                right: 0.5rem;
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            #gameInstructions {
                font-size: 0.8rem;
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <canvas id="artCanvas"></canvas>
    <div class="overlay" id="overlay">
        <h1 id="overlayTitle">–î–∑–µ–Ω-–•–æ–ª—Å—Ç</h1>
        <p id="overlayText">–ù–∞–∂–º–∏—Ç–µ "–°—Ç–∞—Ä—Ç", —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –º–µ–¥–∏—Ç–∞—Ç–∏–≤–Ω—É—é –º–µ–ª–æ–¥–∏—é –∏ —Ç–≤–æ—Ä–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ.</p>
        <button id="startButton" class="start-button">–°—Ç–∞—Ä—Ç</button>
    </div>

    <div class="controls-panel" id="controlsPanel">
        <div class="control-group">
            <label for="languageSelect" id="languageLabel">–Ø–∑—ã–∫:</label>
            <select id="languageSelect">
                <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
                <option value="en">English</option>
            </select>
        </div>
        <div class="control-group">
            <label for="gameModeSelect" id="gameModeLabel">–†–µ–∂–∏–º –∏–≥—Ä—ã:</label>
            <select id="gameModeSelect">
                <option value="free-play" id="freePlayOption">–°–≤–æ–±–æ–¥–Ω–∞—è –∏–≥—Ä–∞</option>
                <option value="echo-sphere" id="echoSphereOption">–≠—Ö–æ-—Å—Ñ–µ—Ä–∞</option>
                <option value="melody-maze" id="melodyMazeOption">–ú–µ–ª–æ–¥–∏—á–Ω—ã–π –ª–∞–±–∏—Ä–∏–Ω—Ç</option>
            </select>
        </div>
        <div id="gameInstructions">
            </div>
        <div class="control-group">
            <label for="volumeSlider" id="volumeLabel">–ì—Ä–æ–º–∫–æ—Å—Ç—å:</label>
            <input type="range" id="volumeSlider" min="-30" max="0" value="-10" step="1">
        </div>
        <div class="control-group">
            <label for="particleMinSizeSlider" id="particleMinSizeLabel">–ú–∏–Ω. —Ä–∞–∑–º–µ—Ä —á–∞—Å—Ç–∏—Ü:</label>
            <input type="range" id="particleMinSizeSlider" min="0.5" max="5" value="2" step="0.1">
        </div>
        <div class="control-group">
            <label for="particleMaxSizeSlider" id="particleMaxSizeLabel">–ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä —á–∞—Å—Ç–∏—Ü:</label>
            <input type="range" id="particleMaxSizeSlider" min="1" max="10" value="8" step="0.1">
        </div>
        <div class="control-group">
            <label for="particleLifeSlider" id="particleLifeLabel">–í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —á–∞—Å—Ç–∏—Ü:</label>
            <input type="range" id="particleLifeSlider" min="50" max="300" value="150" step="10">
        </div>
        <div class="control-group">
            <label for="particleSpeedSlider" id="particleSpeedLabel">–°–∫–æ—Ä–æ—Å—Ç—å —á–∞—Å—Ç–∏—Ü:</label>
            <input type="range" id="particleSpeedSlider" min="0.5" max="5" value="3" step="0.1">
        </div>
        <div class="control-group">
            <label for="particleCountSlider" id="particleCountLabel">–ö–æ–ª-–≤–æ —á–∞—Å—Ç–∏—Ü:</label>
            <input type="range" id="particleCountSlider" min="100" max="800" value="400" step="50">
        </div>
        <div class="control-group">
            <label for="particleSpawnRateSlider" id="particleSpawnRateLabel">–ß–∞—Å—Ç–æ—Ç–∞ —á–∞—Å—Ç–∏—Ü:</label>
            <input type="range" id="particleSpawnRateSlider" min="1" max="10" value="2" step="1">
        </div>
        <div class="control-group">
            <label for="melodyTempoSlider" id="melodyTempoLabel">–¢–µ–º–ø –º–µ–ª–æ–¥–∏–∏:</label>
            <input type="range" id="melodyTempoSlider" min="60" max="180" value="120" step="5">
        </div>
        <div class="control-group">
            <label for="colorPaletteSelect" id="colorPaletteLabel">–ü–∞–ª–∏—Ç—Ä–∞:</label>
            <select id="colorPaletteSelect">
                <option value="dynamic" id="dynamicPaletteOption">–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è (–†–∞–¥—É–≥–∞)</option>
                <option value="warm" id="warmPaletteOption">–¢–µ–ø–ª–∞—è (–ö—Ä–∞—Å–Ω—ã–µ/–û—Ä–∞–Ω–∂–µ–≤—ã–µ)</option>
                <option value="cool" id="coolPaletteOption">–•–æ–ª–æ–¥–Ω–∞—è (–°–∏–Ω–∏–µ/–ó–µ–ª–µ–Ω—ã–µ)</option>
                <option value="pastel" id="pastelPaletteOption">–ü–∞—Å—Ç–µ–ª—å–Ω–∞—è</option>
                <option value="vibrant" id="vibrantPaletteOption">–Ø—Ä–∫–∞—è</option>
            </select>
        </div>
        <div class="control-group">
            <label for="particleShapeSelect" id="particleShapeLabel">–§–æ—Ä–º–∞ —á–∞—Å—Ç–∏—Ü:</label>
            <select id="particleShapeSelect">
                <option value="circle" id="circleShapeOption">–ö—Ä—É–≥</option>
                <option value="square" id="squareShapeOption">–ö–≤–∞–¥—Ä–∞—Ç</option>
                <option value="triangle" id="triangleShapeOption">–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫</option>
            </select>
        </div>
        <div class="control-group">
            <label for="particleMovementSelect" id="particleMovementLabel">–î–≤–∏–∂–µ–Ω–∏–µ —á–∞—Å—Ç–∏—Ü:</label>
            <select id="particleMovementSelect">
                <option value="random" id="randomMovementOption">–°–ª—É—á–∞–π–Ω–æ–µ</option>
                <option value="spiral" id="spiralMovementOption">–°–ø–∏—Ä–∞–ª—å</option>
                <option value="wave" id="waveMovementOption">–í–æ–ª–Ω–∞</option>
            </select>
        </div>
        <div class="control-group">
            <label for="instrumentSelect" id="instrumentLabel">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç:</label>
            <select id="instrumentSelect">
                <option value="simple-poly" id="simplePolyInstrumentOption">–ü–∏–∞–Ω–∏–Ω–æ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</option>
                <option value="fmsynth" id="fmsynthInstrumentOption">FM-—Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä</option>
                <option value="amsynth" id="amsynthInstrumentOption">AM-—Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä</option>
                <option value="pluck" id="pluckInstrumentOption">–ü–ª—é–∫-—Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä</option>
            </select>
        </div>
        <button id="clearCanvasButton" class="action-button">–û—á–∏—Å—Ç–∏—Ç—å —Ö–æ–ª—Å—Ç</button>
        <button id="screenshotButton" class="action-button screenshot-button">–°–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç</button>
        <button id="resetSettingsButton" class="action-button reset-button">–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>
    <button id="menuToggleButton" class="menu-toggle-button">‚ò∞ –ú–µ–Ω—é</button>
    <button id="themeToggleButton" class="theme-toggle-button">–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</button>
    <div id="menuBackdrop" class="menu-backdrop"></div> 
    <script>
        const canvas = document.getElementById('artCanvas');
        const ctx = canvas.getContext('2d');
        const overlay = document.getElementById('overlay');
        const startButton = document.getElementById('startButton');
        const controlsPanel = document.getElementById('controlsPanel');
        const menuToggleButton = document.getElementById('menuToggleButton'); 
        const themeToggleButton = document.getElementById('themeToggleButton');
        const menuBackdrop = document.getElementById('menuBackdrop'); 

        // –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        const languageSelect = document.getElementById('languageSelect'); // –ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
        const volumeSlider = document.getElementById('volumeSlider');
        const particleMinSizeSlider = document.getElementById('particleMinSizeSlider');
        const particleMaxSizeSlider = document.getElementById('particleMaxSizeSlider');
        const particleLifeSlider = document.getElementById('particleLifeSlider');
        const particleSpeedSlider = document.getElementById('particleSpeedSlider');
        const particleCountSlider = document.getElementById('particleCountSlider');
        const particleSpawnRateSlider = document.getElementById('particleSpawnRateSlider');
        const melodyTempoSlider = document.getElementById('melodyTempoSlider'); 
        const colorPaletteSelect = document.getElementById('colorPaletteSelect');
        const particleShapeSelect = document.getElementById('particleShapeSelect');
        const particleMovementSelect = document.getElementById('particleMovementSelect');
        const instrumentSelect = document.getElementById('instrumentSelect');
        const clearCanvasButton = document.getElementById('clearCanvasButton');
        const screenshotButton = document.getElementById('screenshotButton');
        const resetSettingsButton = document.getElementById('resetSettingsButton');

        // –ù–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã
        const gameModeSelect = document.getElementById('gameModeSelect');
        const gameInstructions = document.getElementById('gameInstructions');

        // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–±—Ä–æ—Å–∞) ---
        const defaultSettings = {
            volume: -10,
            particleMinSize: 2, 
            particleMaxSize: 8, 
            particleLife: 150,
            particleSpeed: 3,
            particleCount: 400,
            particleSpawnRate: 2,
            melodyTempo: 120,
            colorPalette: 'dynamic',
            particleShape: 'circle',
            particleMovement: 'random',
            instrument: 'simple-poly',
            theme: 'dark',
            gameMode: 'free-play', // –î–æ–±–∞–≤–ª–µ–Ω —Ä–µ–∂–∏–º –∏–≥—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            language: 'ru' // –Ø–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        };

        // –¶–≤–µ—Ç–æ–≤—ã–µ –ø–∞–ª–∏—Ç—Ä—ã (HSL –∑–Ω–∞—á–µ–Ω–∏—è)
        const colorPalettes = {
            dynamic: [], 
            warm: [
                { h: 0, s: 70, l: 50 }, { h: 30, s: 70, l: 50 }, { h: 60, s: 70, l: 50 }
            ],
            cool: [
                { h: 180, s: 70, l: 50 }, { h: 210, s: 70, l: 50 }, { h: 240, s: 70, l: 50 }
            ],
            pastel: [
                { h: 300, s: 40, l: 70 }, { h: 120, s: 40, l: 70 }, { h: 240, s: 40, l: 70 }
            ],
            vibrant: [
                { h: 0, s: 90, l: 60 }, { h: 120, s: 90, l: 60 }, { h: 240, s: 90, l: 60 }, { h: 60, s: 90, l: 60 }
            ]
        };

        // --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è ---
        let particles = [];
        let maxParticles = parseInt(particleCountSlider.value);
        let particleBaseSpeed = parseFloat(particleSpeedSlider.value);
        let particleMinSize = parseFloat(particleMinSizeSlider.value);
        let particleMaxSize = parseFloat(particleMaxSizeSlider.value);
        let particleLife = parseInt(particleLifeSlider.value);
        let particleSpawnRate = defaultSettings.particleSpawnRate;
        let currentParticleShape = defaultSettings.particleShape;
        let currentColorPalette = defaultSettings.colorPalette;
        let currentParticleMovement = defaultSettings.particleMovement;
        let currentInstrument = defaultSettings.instrument;
        let hue = 0;
        let particlePulseFactor = 0;
        let audioAnalyzer;

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
        let reverb;
        let delay;

        // –¢–µ–∫—É—â–∞—è —Ç–µ–º–∞ –∏ —Ä–µ–∂–∏–º –∏–≥—Ä—ã
        let currentTheme = defaultSettings.theme;
        let gameMode = defaultSettings.gameMode; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã

        // –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è Melody Maze
        let currentMazePath = []; // –ë—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞
        const mazeLineTolerance = 50; // –ù–∞—Å–∫–æ–ª—å–∫–æ –±–ª–∏–∑–∫–æ –∫—É—Ä—Å–æ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫ –ª–∏–Ω–∏–∏
        const mazeNotes = ["C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5"]; // –ù–æ—Ç—ã –¥–ª—è –º–µ–ª–æ–¥–∏–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ (C Major Scale)
        let mazeSynth; // –°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä –¥–ª—è –º–µ–ª–æ–¥–∏–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞
        let mazeSequence; // Tone.Sequence –¥–ª—è –º–µ–ª–æ–¥–∏–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞
        let isMazePlayingAudio = false; // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞
        let synth; // –û–±—ä—è–≤–ª–µ–Ω–∏–µ synth –∑–¥–µ—Å—å
        let loop; // –û–±—ä—è–≤–ª–µ–Ω–∏–µ loop –∑–¥–µ—Å—å
        let interactionSynth; // –û–±—ä—è–≤–ª–µ–Ω–∏–µ interactionSynth –∑–¥–µ—Å—å
        let isPlaying = false; // –§–ª–∞–≥ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–≥—Ä–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ (–ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è "–°—Ç–∞—Ä—Ç")

        // --- –û–±—ä–µ–∫—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤ ---
        const translations = {
            ru: {
                recordStart: "üé• –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å",
                recordStop: "‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å",
                overlayTitle: '–î–∑–µ–Ω-–•–æ–ª—Å—Ç',
                overlayText: '–ù–∞–∂–º–∏—Ç–µ "–°—Ç–∞—Ä—Ç", —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –º–µ–¥–∏—Ç–∞—Ç–∏–≤–Ω—É—é –º–µ–ª–æ–¥–∏—é –∏ —Ç–≤–æ—Ä–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ.',
                startButton: '–°—Ç–∞—Ä—Ç',
                languageLabel: '–Ø–∑—ã–∫:',
                gameModeLabel: '–†–µ–∂–∏–º –∏–≥—Ä—ã:',
                freePlayOption: '–°–≤–æ–±–æ–¥–Ω–∞—è –∏–≥—Ä–∞',
                echoSphereOption: '–≠—Ö–æ-—Å—Ñ–µ—Ä–∞',
                melodyMazeOption: '–ú–µ–ª–æ–¥–∏—á–Ω—ã–π –ª–∞–±–∏—Ä–∏–Ω—Ç',
                volumeLabel: '–ì—Ä–æ–º–∫–æ—Å—Ç—å:',
                particleMinSizeLabel: '–ú–∏–Ω. —Ä–∞–∑–º–µ—Ä —á–∞—Å—Ç–∏—Ü:',
                particleMaxSizeLabel: '–ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä —á–∞—Å—Ç–∏—Ü:',
                particleLifeLabel: '–í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —á–∞—Å—Ç–∏—Ü:',
                particleSpeedLabel: '–°–∫–æ—Ä–æ—Å—Ç—å —á–∞—Å—Ç–∏—Ü:',
                particleCountLabel: '–ö–æ–ª-–≤–æ —á–∞—Å—Ç–∏—Ü:',
                particleSpawnRateLabel: '–ß–∞—Å—Ç–æ—Ç–∞ —á–∞—Å—Ç–∏—Ü:',
                melodyTempoLabel: '–¢–µ–º–ø –º–µ–ª–æ–¥–∏–∏:',
                colorPaletteLabel: '–ü–∞–ª–∏—Ç—Ä–∞:',
                dynamicPaletteOption: '–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è (–†–∞–¥—É–≥–∞)',
                warmPaletteOption: '–¢–µ–ø–ª–∞—è (–ö—Ä–∞—Å–Ω—ã–µ/–û—Ä–∞–Ω–∂–µ–≤—ã–µ)',
                coolPaletteOption: '–•–æ–ª–æ–¥–Ω–∞—è (–°–∏–Ω–∏–µ/–ó–µ–ª–µ–Ω—ã–µ)',
                pastelPaletteOption: '–ü–∞—Å—Ç–µ–ª—å–Ω–∞—è',
                vibrantPaletteOption: '–Ø—Ä–∫–∞—è',
                particleShapeLabel: '–§–æ—Ä–º–∞ —á–∞—Å—Ç–∏—Ü:',
                circleShapeOption: '–ö—Ä—É–≥',
                squareShapeOption: '–ö–≤–∞–¥—Ä–∞—Ç',
                triangleShapeOption: '–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫',
                particleMovementLabel: '–î–≤–∏–∂–µ–Ω–∏–µ —á–∞—Å—Ç–∏—Ü:',
                randomMovementOption: '–°–ª—É—á–∞–π–Ω–æ–µ',
                spiralMovementOption: '–°–ø–∏—Ä–∞–ª—å',
                waveMovementOption: '–í–æ–ª–Ω–∞',
                instrumentLabel: '–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç:',
                simplePolyInstrumentOption: '–ü–∏–∞–Ω–∏–Ω–æ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)',
                fmsynthInstrumentOption: 'FM-—Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä',
                amsynthInstrumentOption: 'AM-—Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä',
                pluckInstrumentOption: '–ü–ª—é–∫-—Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä',
                clearCanvasButton: '–û—á–∏—Å—Ç–∏—Ç—å —Ö–æ–ª—Å—Ç',
                screenshotButton: '–°–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç',
                resetSettingsButton: '–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏',
                menuButtonOpen: '‚ò∞ –ú–µ–Ω—é',
                menuButtonClose: '‚úñ –ó–∞–∫—Ä—ã—Ç—å',
                themeButtonLight: '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞',
                themeButtonDark: '–¢–µ–º–Ω–∞—è —Ç–µ–º–∞',
                freePlayInstructions: '<strong>–°–≤–æ–±–æ–¥–Ω–∞—è –∏–≥—Ä–∞:</strong> –î–≤–∏–≥–∞–π—Ç–µ –º—ã—à—å—é/–ø–∞–ª—å—Ü–µ–º, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å —á–∞—Å—Ç–∏—Ü—ã. –§–æ–Ω–æ–≤–∞—è –º–µ–ª–æ–¥–∏—è –±—É–¥–µ—Ç –∏–≥—Ä–∞—Ç—å.',
                echoSphereInstructions: '<strong>–≠—Ö–æ-—Å—Ñ–µ—Ä–∞:</strong> –ù–∞–∂–º–∏—Ç–µ –∏ —É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –º—ã—à—å/–ø–∞–ª–µ—Ü, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∑–≤—É–∫–æ–≤—É—é —Å—Ñ–µ—Ä—É. –û—Ç–ø—É—Å—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å.',
                melodyMazeInstructions: '<strong>–ú–µ–ª–æ–¥–∏—á–Ω—ã–π –ª–∞–±–∏—Ä–∏–Ω—Ç:</strong> –ü—Ä–æ–≤–µ–¥–∏—Ç–µ –º—ã—à—å—é/–ø–∞–ª—å—Ü–µ–º –≤–¥–æ–ª—å —Å–∏–Ω–µ–π –ª–∏–Ω–∏–∏, —á—Ç–æ–±—ã —É—Å–ª—ã—à–∞—Ç—å –º–µ–ª–æ–¥–∏—é. –ù–æ–≤—ã–π –ª–∞–±–∏—Ä–∏–Ω—Ç –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ!',
                selectGameModeInstructions: '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –∏–≥—Ä—ã.',
                audioStartError: '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞.'
            
            },
            uk: {
                recordStart: 'üé• –ó–∞–ø–∏—Å –≤—ñ–¥–µ–æ',
                recordStop: '‚èπÔ∏è –ó—É–ø–∏–Ω–∏—Ç–∏ –∑–∞–ø–∏—Å',
                overlayTitle: '–î–∑–µ–Ω-–ü–æ–ª–æ—Ç–Ω–æ',
                overlayText: '–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–°—Ç–∞—Ä—Ç", —â–æ–± —Ä–æ–∑–ø–æ—á–∞—Ç–∏ –º–µ–¥–∏—Ç–∞—Ç–∏–≤–Ω—É –º–µ–ª–æ–¥—ñ—é —Ç–∞ —Ç–≤–æ—Ä–∏—Ç–∏ –≤—ñ–∑—É–∞–ª—å–Ω–µ –º–∏—Å—Ç–µ—Ü—Ç–≤–æ.',
                startButton: '–°—Ç–∞—Ä—Ç',
                languageLabel: '–ú–æ–≤–∞:',
                gameModeLabel: '–†–µ–∂–∏–º –≥—Ä–∏:',
                freePlayOption: '–í—ñ–ª—å–Ω–∞ –≥—Ä–∞',
                echoSphereOption: '–ï—Ö–æ-—Å—Ñ–µ—Ä–∞',
                melodyMazeOption: '–ú–µ–ª–æ–¥—ñ–π–Ω–∏–π –ª–∞–±—ñ—Ä–∏–Ω—Ç',
                volumeLabel: '–ì—É—á–Ω—ñ—Å—Ç—å:',
                particleMinSizeLabel: '–ú—ñ–Ω. —Ä–æ–∑–º—ñ—Ä —á–∞—Å—Ç–∏–Ω–æ–∫:',
                particleMaxSizeLabel: '–ú–∞–∫—Å. —Ä–æ–∑–º—ñ—Ä —á–∞—Å—Ç–∏–Ω–æ–∫:',
                particleLifeLabel: '–ß–∞—Å –∂–∏—Ç—Ç—è —á–∞—Å—Ç–∏–Ω–æ–∫:',
                particleSpeedLabel: '–®–≤–∏–¥–∫—ñ—Å—Ç—å —á–∞—Å—Ç–∏–Ω–æ–∫:',
                particleCountLabel: '–ö—ñ–ª—å–∫—ñ—Å—Ç—å —á–∞—Å—Ç–∏–Ω–æ–∫:',
                particleSpawnRateLabel: '–ß–∞—Å—Ç–æ—Ç–∞ —á–∞—Å—Ç–∏–Ω–æ–∫:',
                melodyTempoLabel: '–¢–µ–º–ø –º–µ–ª–æ–¥—ñ—ó:',
                colorPaletteLabel: '–ü–∞–ª—ñ—Ç—Ä–∞:',
                dynamicPaletteOption: '–î–∏–Ω–∞–º—ñ—á–Ω–∞ (–í–µ—Å–µ–ª–∫–∞)',
                warmPaletteOption: '–¢–µ–ø–ª–∞ (–ß–µ—Ä–≤–æ–Ω—ñ/–ü–æ–º–∞—Ä–∞–Ω—á–µ–≤—ñ)',
                coolPaletteOption: '–•–æ–ª–æ–¥–Ω–∞ (–°–∏–Ω—ñ/–ó–µ–ª–µ–Ω—ñ)',
                pastelPaletteOption: '–ü–∞—Å—Ç–µ–ª—å–Ω–∞',
                vibrantPaletteOption: '–Ø—Å–∫—Ä–∞–≤–∞',
                particleShapeLabel: '–§–æ—Ä–º–∞ —á–∞—Å—Ç–∏–Ω–æ–∫:',
                circleShapeOption: '–ö–æ–ª–æ',
                squareShapeOption: '–ö–≤–∞–¥—Ä–∞—Ç',
                triangleShapeOption: '–¢—Ä–∏–∫—É—Ç–Ω–∏–∫',
                particleMovementLabel: '–†—É—Ö —á–∞—Å—Ç–∏–Ω–æ–∫:',
                randomMovementOption: '–í–∏–ø–∞–¥–∫–æ–≤–∏–π',
                spiralMovementOption: '–°–ø—ñ—Ä–∞–ª—å',
                waveMovementOption: '–•–≤–∏–ª—è',
                instrumentLabel: '–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç:',
                simplePolyInstrumentOption: '–ü—ñ–∞–Ω—ñ–Ω–æ (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º)',
                fmsynthInstrumentOption: 'FM-—Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä',
                amsynthInstrumentOption: 'AM-—Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä',
                pluckInstrumentOption: '–ü–ª—é–∫-—Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä',
                clearCanvasButton: '–û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ª–æ—Ç–Ω–æ',
                screenshotButton: '–ó—Ä–æ–±–∏—Ç–∏ –∑–Ω—ñ–º–æ–∫ –µ–∫—Ä–∞–Ω–∞',
                resetSettingsButton: '–°–∫–∏–Ω—É—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è',
                menuButtonOpen: '‚ò∞ –ú–µ–Ω—é',
                menuButtonClose: '‚úñ –ó–∞–∫—Ä–∏—Ç–∏',
                themeButtonLight: '–°–≤—ñ—Ç–ª–∞ —Ç–µ–º–∞',
                themeButtonDark: '–¢–µ–º–Ω–∞ —Ç–µ–º–∞',
                freePlayInstructions: '<strong>–í—ñ–ª—å–Ω–∞ –≥—Ä–∞:</strong> –†—É—Ö–∞–π—Ç–µ –º–∏—à–µ—é/–ø–∞–ª—å—Ü–µ–º, —â–æ–± —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —á–∞—Å—Ç–∏–Ω–∫–∏. –§–æ–Ω–æ–≤–∞ –º–µ–ª–æ–¥—ñ—è –≥—Ä–∞—Ç–∏–º–µ.',
                echoSphereInstructions: '<strong>–ï—Ö–æ-—Å—Ñ–µ—Ä–∞:</strong> –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å —ñ —É—Ç—Ä–∏–º—É–π—Ç–µ –º–∏—à—É/–ø–∞–ª–µ—Ü—å, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑–≤—É–∫–æ–≤—É —Å—Ñ–µ—Ä—É. –í—ñ–¥–ø—É—Å—Ç—ñ—Ç—å, —â–æ–± –∑—É–ø–∏–Ω–∏—Ç–∏.',
                melodyMazeInstructions: '<strong>–ú–µ–ª–æ–¥—ñ–π–Ω–∏–π –ª–∞–±—ñ—Ä–∏–Ω—Ç:</strong> –ü—Ä–æ–≤–µ–¥—ñ—Ç—å –º–∏—à–µ—é/–ø–∞–ª—å—Ü–µ–º —É–∑–¥–æ–≤–∂ —Å–∏–Ω—å–æ—ó –ª—ñ–Ω—ñ—ó, —â–æ–± –ø–æ—á—É—Ç–∏ –º–µ–ª–æ–¥—ñ—é. –ù–æ–≤–∏–π –ª–∞–±—ñ—Ä–∏–Ω—Ç –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É –∑–∞–ø—É—Å–∫—É!',
                selectGameModeInstructions: '–í–∏–±–µ—Ä—ñ—Ç—å —Ä–µ–∂–∏–º –≥—Ä–∏.',
                audioStartError: '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏. –ë—É–¥—å –ª–∞—Å–∫–∞, —Å–ø—Ä–æ–±—É–π—Ç–µ –∑–Ω–æ–≤—É –∞–±–æ –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±—Ä–∞—É–∑–µ—Ä–∞.',
            },
            en: {
                recordStart: 'üé• Start Recording',
                recordStop: '‚èπÔ∏è Stop Recording',
                overlayTitle: 'Zen Canvas',
                overlayText: 'Click "Start" to begin a meditative melody and create visual art.',
                startButton: 'Start',
                languageLabel: 'Language:',
                gameModeLabel: 'Game Mode:',
                freePlayOption: 'Free Play',
                echoSphereOption: 'Echo Sphere',
                melodyMazeOption: 'Melody Maze',
                volumeLabel: 'Volume:',
                particleMinSizeLabel: 'Min Particle Size:',
                particleMaxSizeLabel: 'Max Particle Size:',
                particleLifeLabel: 'Particle Life:',
                particleSpeedLabel: 'Particle Speed:',
                particleCountLabel: 'Particle Count:',
                particleSpawnRateLabel: 'Particle Spawn Rate:',
                melodyTempoLabel: 'Melody Tempo:',
                colorPaletteLabel: 'Palette:',
                dynamicPaletteOption: 'Dynamic (Rainbow)',
                warmPaletteOption: 'Warm (Reds/Oranges)',
                coolPaletteOption: 'Cool (Blues/Greens)',
                pastelPaletteOption: 'Pastel',
                vibrantPaletteOption: 'Vibrant',
                particleShapeLabel: 'Particle Shape:',
                circleShapeOption: 'Circle',
                squareShapeOption: 'Square',
                triangleShapeOption: 'Triangle',
                particleMovementLabel: 'Particle Movement:',
                randomMovementOption: 'Random',
                spiralMovementOption: 'Spiral',
                waveMovementOption: 'Wave',
                instrumentLabel: 'Instrument:',
                simplePolyInstrumentOption: 'Piano (default)',
                fmsynthInstrumentOption: 'FM Synth',
                amsynthInstrumentOption: 'AM Synth',
                pluckInstrumentOption: 'Pluck Synth',
                clearCanvasButton: 'Clear Canvas',
                screenshotButton: 'Take Screenshot',
                resetSettingsButton: 'Reset Settings',
                menuButtonOpen: '‚ò∞ Menu',
                menuButtonClose: '‚úñ Close',
                themeButtonLight: 'Light Theme',
                themeButtonDark: 'Dark Theme',
                freePlayInstructions: '<strong>Free Play:</strong> Move your mouse/finger to create particles. A background melody will play.',
                echoSphereInstructions: '<strong>Echo Sphere:</strong> Press and hold your mouse/finger to create a sound sphere. Release to stop.',
                melodyMazeInstructions: '<strong>Melody Maze:</strong> Drag your mouse/finger along the blue line to hear a melody. A new maze each time!',
                selectGameModeInstructions: 'Select a game mode.',
                audioStartError: 'Failed to start. Please try again or check your browser settings.',
            }
        };

        let currentLanguage = defaultSettings.language; // –¢–µ–∫—É—â–∏–π —è–∑—ã–∫

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —è–∑—ã–∫–∞
        function setLanguage(langCode) {
            currentLanguage = langCode;
            document.documentElement.lang = langCode; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞—Ç—Ä–∏–±—É—Ç lang –¥–ª—è HTML

            const currentTranslation = translations[langCode];
            const recordButton = document.getElementById("recordButton");
            if (recordButton) {
                recordButton.textContent = (mediaRecorder && mediaRecorder.state === "recording")
                    ? currentTranslation.recordStop
                    : currentTranslation.recordStart;
            }


            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ –æ–≤–µ—Ä–ª–µ–µ
            document.getElementById('overlayTitle').textContent = currentTranslation.overlayTitle;
            document.getElementById('overlayText').textContent = currentTranslation.overlayText;
            document.getElementById('startButton').textContent = currentTranslation.startButton;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            document.getElementById('languageLabel').textContent = currentTranslation.languageLabel;
            document.getElementById('gameModeLabel').textContent = currentTranslation.gameModeLabel;
            document.getElementById('freePlayOption').textContent = currentTranslation.freePlayOption;
            document.getElementById('echoSphereOption').textContent = currentTranslation.echoSphereOption;
            document.getElementById('melodyMazeOption').textContent = currentTranslation.melodyMazeOption;
            document.getElementById('volumeLabel').textContent = currentTranslation.volumeLabel;
            document.getElementById('particleMinSizeLabel').textContent = currentTranslation.particleMinSizeLabel;
            document.getElementById('particleMaxSizeLabel').textContent = currentTranslation.particleMaxSizeLabel;
            document.getElementById('particleLifeLabel').textContent = currentTranslation.particleLifeLabel;
            document.getElementById('particleSpeedLabel').textContent = currentTranslation.particleSpeedLabel;
            document.getElementById('particleCountLabel').textContent = currentTranslation.particleCountLabel;
            document.getElementById('particleSpawnRateLabel').textContent = currentTranslation.particleSpawnRateLabel;
            document.getElementById('melodyTempoLabel').textContent = currentTranslation.melodyTempoLabel;
            document.getElementById('colorPaletteLabel').textContent = currentTranslation.colorPaletteLabel;
            document.getElementById('dynamicPaletteOption').textContent = currentTranslation.dynamicPaletteOption;
            document.getElementById('warmPaletteOption').textContent = currentTranslation.warmPaletteOption;
            document.getElementById('coolPaletteOption').textContent = currentTranslation.coolPaletteOption;
            document.getElementById('pastelPaletteOption').textContent = currentTranslation.pastelPaletteOption;
            document.getElementById('vibrantPaletteOption').textContent = currentTranslation.vibrantPaletteOption;
            document.getElementById('particleShapeLabel').textContent = currentTranslation.particleShapeLabel;
            document.getElementById('circleShapeOption').textContent = currentTranslation.circleShapeOption;
            document.getElementById('squareShapeOption').textContent = currentTranslation.squareShapeOption;
            document.getElementById('triangleShapeOption').textContent = currentTranslation.triangleShapeOption;
            document.getElementById('particleMovementLabel').textContent = currentTranslation.particleMovementLabel;
            document.getElementById('randomMovementOption').textContent = currentTranslation.randomMovementOption;
            document.getElementById('spiralMovementOption').textContent = currentTranslation.spiralMovementOption;
            document.getElementById('waveMovementOption').textContent = currentTranslation.waveMovementOption;
            document.getElementById('instrumentLabel').textContent = currentTranslation.instrumentLabel;
            document.getElementById('simplePolyInstrumentOption').textContent = currentTranslation.simplePolyInstrumentOption;
            document.getElementById('fmsynthInstrumentOption').textContent = currentTranslation.fmsynthInstrumentOption;
            document.getElementById('amsynthInstrumentOption').textContent = currentTranslation.amsynthInstrumentOption;
            document.getElementById('pluckInstrumentOption').textContent = currentTranslation.pluckInstrumentOption;
            document.getElementById('clearCanvasButton').textContent = currentTranslation.clearCanvasButton;
            document.getElementById('screenshotButton').textContent = currentTranslation.screenshotButton;
            document.getElementById('resetSettingsButton').textContent = currentTranslation.resetSettingsButton;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
            menuToggleButton.textContent = controlsPanel.classList.contains('visible') ? currentTranslation.menuButtonClose : currentTranslation.menuButtonOpen;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Ç–µ–º—ã
            themeToggleButton.textContent = currentTheme === 'dark' ? currentTranslation.themeButtonLight : currentTranslation.themeButtonDark;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∏–≥—Ä—ã
            updateGameInstructions();

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫
            localStorage.setItem('zenLanguage', langCode);
        }

        // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö–æ–ª—Å—Ç–∞ ---
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            // –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ª–∞–±–∏—Ä–∏–Ω—Ç –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ —Ö–æ–ª—Å—Ç–∞
            if (gameMode === 'melody-maze') {
                generateRandomMazePath();
            }
        }
        window.addEventListener('resize', resizeCanvas);
        // resizeCanvas(); // –í—ã–∑–æ–≤ –∑–¥–µ—Å—å –Ω–µ –Ω—É–∂–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω –≤ window.onload

        // Function to update game instructions based on current game mode
        function updateGameInstructions() {
            const currentTranslation = translations[currentLanguage];
            switch (gameMode) {
                case 'free-play':
                    gameInstructions.innerHTML = currentTranslation.freePlayInstructions;
                    break;
                case 'echo-sphere':
                    gameInstructions.innerHTML = currentTranslation.echoSphereInstructions;
                    break;
                case 'melody-maze':
                    gameInstructions.innerHTML = currentTranslation.melodyMazeInstructions;
                    break;
                default:
                    gameInstructions.innerHTML = currentTranslation.selectGameModeInstructions;
            }
        }

        // Helper function to calculate distance from a point to a line segment
        function distToSegmentSquared(p, v, w) {
            const l2 = (w.x - v.x) * (w.x - v.x) + (w.y - v.y) * (w.y - v.y);
            if (l2 === 0) return (p.x - v.x) * (p.x - v.x) + (p.y - v.y) * (p.y - v.y);
            let t = ((p.x - v.x) * (w.x - v.x) + (p.y - v.y) * (w.y - v.y)) / l2;
            t = Math.max(0, Math.min(1, t));
            const projection = {
                x: v.x + t * (w.x - v.x),
                y: v.y + t * (w.y - v.y)
            };
            return (p.x - projection.x) * (p.x - projection.x) + (p.y - projection.y) * (p.y - projection.y);
        }

        function distToSegment(p, v, w) {
            return Math.sqrt(distToSegmentSquared(p, v, w));
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø—É—Ç–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞
        function generateRandomMazePath() {
            currentMazePath = [];
            const minX = 0.1; // –ù–∞—á–∞–ª–æ –ø—É—Ç–∏ –æ—Ç 10% —à–∏—Ä–∏–Ω—ã
            const maxX = 0.9; // –ö–æ–Ω–µ—Ü –ø—É—Ç–∏ –¥–æ 90% —à–∏—Ä–∏–Ω—ã
            const minY = 0.1; // –í–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ –ø—É—Ç–∏
            const maxY = 0.9; // –ù–∏–∂–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ –ø—É—Ç–∏
            const minSegmentLength = 0.05; // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–µ–≥–º–µ–Ω—Ç–∞
            const maxSegmentLength = 0.15; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–µ–≥–º–µ–Ω—Ç–∞
            const maxAngleChange = Math.PI / 4; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —É–≥–ª–∞ (45 –≥—Ä–∞–¥—É—Å–æ–≤)
            // const pathSmoothness = 0.5; // –§–∞–∫—Ç–æ—Ä —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è –ø—É—Ç–∏ (0-1, 0 - –ª–æ–º–∞–Ω–∞—è, 1 - –ø—Ä—è–º–∞—è) // –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é

            let currentX = minX;
            let currentY = Math.random() * (maxY - minY) + minY; // –°–ª—É—á–∞–π–Ω–∞—è –Ω–∞—á–∞–ª—å–Ω–∞—è Y
            let currentAngle = Math.random() * Math.PI / 2 - Math.PI / 4; // –ù–∞—á–∞–ª—å–Ω—ã–π —É–≥–æ–ª –æ–∫–æ–ª–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ

            currentMazePath.push({ x: currentX * canvas.width, y: currentY * canvas.height });

            while (currentX < maxX) {
                // –°–ª—É—á–∞–π–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —É–≥–ª–∞
                currentAngle += (Math.random() - 0.5) * maxAngleChange * 2;
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —É–≥–æ–ª, —á—Ç–æ–±—ã –ø—É—Ç—å –Ω–µ —É—Ö–æ–¥–∏–ª —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑
                currentAngle = Math.max(-Math.PI / 2 + 0.1, Math.min(Math.PI / 2 - 0.1, currentAngle));

                const segmentLength = (Math.random() * (maxSegmentLength - minSegmentLength) + minSegmentLength);
                
                let nextX = currentX + Math.cos(currentAngle) * segmentLength;
                let nextY = currentY + Math.sin(currentAngle) * segmentLength;

                // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞, —á—Ç–æ–±—ã –ø—É—Ç—å –æ—Å—Ç–∞–≤–∞–ª—Å—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ö–æ–ª—Å—Ç–∞
                nextX = Math.max(minX, Math.min(maxX, nextX));
                nextY = Math.max(minY, Math.min(maxY, nextY));

                currentMazePath.push({ x: nextX * canvas.width, y: nextY * canvas.height });

                currentX = nextX;
                currentY = nextY;
            }
            // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è —Ç–æ—á–∫–∞ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç –ø—Ä–∞–≤–æ–π –≥—Ä–∞–Ω–∏—Ü—ã
            currentMazePath[currentMazePath.length - 1].x = maxX * canvas.width;
        }


        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —á–∞—Å—Ç–∏—Ü—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º—ã
        function drawParticle(p) {
            ctx.fillStyle = p.color;
            ctx.globalAlpha = p.alpha;

            switch (currentParticleShape) {
                case 'circle':
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2); 
                    ctx.fill();
                    break;
                case 'square':
                    const size = p.radius * 2; 
                    ctx.fillRect(p.x - size / 2, p.y - size / 2, size, size);
                    break;
                case 'triangle':
                    const triHeight = p.radius * 2 * (Math.sqrt(3) / 2); 
                    const triBase = p.radius * 2; 
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y - triHeight / 2);
                    ctx.lineTo(p.x - triBase / 2, p.y + triHeight / 2);
                    ctx.lineTo(p.x + triBase / 2, p.y + triHeight / 2);
                    ctx.closePath();
                    ctx.fill();
                    break;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ —á–∞—Å—Ç–∏—Ü—ã –∏–∑ –ø–∞–ª–∏—Ç—Ä—ã
        function getParticleColor() {
            const lightness = currentTheme === 'light' ? 70 : 50;
            if (currentColorPalette === 'dynamic') {
                return `hsl(${hue}, 70%, ${lightness}%)`;
            } else {
                const palette = colorPalettes[currentColorPalette];
                const colorIndex = Math.floor(Math.random() * palette.length);
                const color = palette[colorIndex];
                return `hsl(${color.h}, ${color.s}%, ${color.l}%)`; 
            }
        }

        // Tone.js Synth –¥–ª—è –∑–≤—É–∫–æ–≤ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è (—Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è "–≠—Ö–æ-—Å—Ñ–µ—Ä—ã")
        let activeEchoSynthNote = null; // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–π –Ω–æ—Ç—ã –≤ —Ä–µ–∂–∏–º–µ "–≠—Ö–æ-—Å—Ñ–µ—Ä–∞"

        function createParticle(x, y) {
            const baseRadius = Math.random() * (particleMaxSize - particleMinSize) + particleMinSize;
            const radius = baseRadius + particlePulseFactor * 2;
            let speedX = (Math.random() - 0.5) * particleBaseSpeed;
            let speedY = (Math.random() - 0.5) * particleBaseSpeed;

            // –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Å—Ç–∏—Ü –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã
            if (gameMode === 'echo-sphere') {
                const angle = Math.random() * Math.PI * 2; // –°–ª—É—á–∞–π–Ω—ã–π —É–≥–æ–ª –¥–ª—è —Ä–∞–¥–∏–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–ª–µ—Ç–∞
                particles.push({
                    x: x, 
                    y: y, 
                    initialX: x, // –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞–∑–ª–µ—Ç–∞
                    initialY: y,
                    angle: angle, // –£–≥–æ–ª —Ä–∞–∑–ª–µ—Ç–∞
                    radius: radius * 0.5, // –ù–∞—á–∏–Ω–∞–µ–º —Å –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–¥–∏—É—Å–∞
                    color: getParticleColor(),
                    alpha: 1,
                    speedX: Math.cos(angle) * (particleBaseSpeed * 1.5), // –ù–∞—á–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–∑–ª–µ—Ç–∞
                    speedY: Math.sin(angle) * (particleBaseSpeed * 1.5),
                    life: particleLife * 3, // –£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ —Å—Ñ–µ—Ä—ã
                    spawnTime: Tone.now() // –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Å—Ç–∏—Ü—ã
                });
                return; // –í—ã—Ö–æ–¥–∏–º, —Ç–∞–∫ –∫–∞–∫ —á–∞—Å—Ç–∏—Ü–∞ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞
            }

            // –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Å–≤–æ–±–æ–¥–Ω–æ–π –∏–≥—Ä—ã –∏ –¥—Ä—É–≥–∏—Ö –¥–≤–∏–∂–µ–Ω–∏–π
            if (currentParticleMovement === 'spiral') {
                const angle = Math.atan2(y - canvas.height / 2, x - canvas.width / 2);
                const distance = Math.sqrt(Math.pow(x - canvas.width / 2, 2) + Math.pow(y - canvas.height / 2, 2));
                speedX = Math.cos(angle + Math.PI / 2) * (particleBaseSpeed * 0.5) + (x - canvas.width / 2) * 0.001;
                speedY = Math.sin(angle + Math.PI / 2) * (particleBaseSpeed * 0.5) + (y - canvas.height / 2) * 0.001;
            } else if (currentParticleMovement === 'wave') {
                speedX = Math.sin(x * 0.05 + hue * 0.01) * particleBaseSpeed * 0.8;
                speedY = Math.cos(y * 0.05 + hue * 0.01) * particleBaseSpeed * 0.8;
            }

            particles.push({
                x: x,
                y: y,
                radius: radius,
                color: getParticleColor(),
                alpha: 1,
                speedX: speedX,
                speedY: speedY,
                life: particleLife
            });
            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Å–≤–æ–±–æ–¥–Ω–æ–π –∏–≥—Ä—ã
            if (isPlaying && interactionSynth && gameMode === 'free-play') {
                interactionSynth.triggerAttackRelease("C5", "16n", Tone.now() + Math.random() * 0.01);
            }
        }

        // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∞—É–¥–∏–æ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ (–º–µ–ª–æ–¥–∏—è) ---
        const notes = ["C3", "D3", "E3", "G3", "A3", "C4", "D4", "E4", "G4", "A4"];

        function createSynth(instrumentType) {
            // –ù–µ –¥–∏—Å–ø–æ–∑–∏—Ä—É–µ–º –∑–¥–µ—Å—å, —Ç–∞–∫ –∫–∞–∫ —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –≤ startAudioAndVisuals
            let newSynth;
            switch (instrumentType) {
                case 'simple-poly':
                    newSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: "sine" },
                        envelope: { attack: 2, decay: 1, sustain: 0.5, release: 4 }
                    });
                    break;
                case 'fmsynth':
                    newSynth = new Tone.FMSynth({ 
                        harmonicity: 3.0,
                        modulationIndex: 10,
                        oscillator: { type: "sine" },
                        envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 1.2 },
                        modulation: { type: "triangle" },
                        modulationEnvelope: { attack: 0.05, decay: 0.2, sustain: 0.0, release: 0.5 }
                    });
                    break;
                case 'amsynth':
                    newSynth = new Tone.AMSynth({ 
                        harmonicity: 2.5,
                        oscillator: { type: "sine" },
                        envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 1.2 },
                        modulation: { type: "square" },
                        modulationEnvelope: { attack: 0.05, decay: 0.4, sustain: 0.2, release: 0.5 }
                    });
                    break;
                case 'pluck':
                    newSynth = new Tone.PluckSynth({ 
                        attackNoise: 1,
                        dampening: 4000,
                        resonance: 0.7
                    });
                    break;
                default:
                    newSynth = new Tone.PolySynth(Tone.Synth, { 
                        oscillator: { type: "sine" },
                        envelope: { attack: 2, decay: 1, sustain: 0.5, release: 4 }
                    });
            }
            return newSynth;
        }


        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–æ–≥–æ —Ñ–æ–Ω–∞
        let bgHue1 = 0;
        let bgHue2 = 180;
        let bgLightness = 5; 

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ —Ñ–æ–Ω–∞
        function drawDynamicBackground() {
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            const currentAudioLevelDB = audioAnalyzer && isPlaying ? audioAnalyzer.getLevel() : -60; 
            const normalizedLevel = Math.max(0, (currentAudioLevelDB + 60) / 60); 
            
            const minBgLightness = currentTheme === 'light' ? 80 : 5;
            const maxBgLightness = currentTheme === 'light' ? 95 : 20; 
            const dynamicLightness = minBgLightness + (normalizedLevel * (maxBgLightness - minBgLightness));

            gradient.addColorStop(0, `hsl(${bgHue1}, 50%, ${dynamicLightness}%)`);
            gradient.addColorStop(1, `hsl(${bgHue2}, 50%, ${dynamicLightness}%)`);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            bgHue1 = (bgHue1 + 0.05) % 360;
            bgHue2 = (bgHue2 + 0.05) % 360;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –∑–∞–ø—É—Å–∫–∞ –∞—É–¥–∏–æ –∏ –≤–∏–∑—É–∞–ª–æ–≤
        async function startAudioAndVisuals() {
            if (isPlaying) return; // –ï—Å–ª–∏ —É–∂–µ –∏–≥—Ä–∞–µ—Ç, –≤—ã—Ö–æ–¥–∏–º

            try {
                await Tone.start(); // –ó–∞–ø—É—Å–∫–∞–µ–º –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç
                console.log('–ê—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–ø—É—â–µ–Ω!');

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –∏ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞, –µ—Å–ª–∏ –æ–Ω–∏ –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
                if (!reverb) {
                    reverb = new Tone.Reverb({ decay: 8, preDelay: 0.2, wet: 0.6 }).toDestination();
                }
                if (!delay) {
                    delay = new Tone.FeedbackDelay({ delayTime: "4n", feedback: 0.5, wet: 0.3 }).connect(reverb);
                }
                if (!audioAnalyzer) {
                    audioAnalyzer = new Tone.Meter();
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
                if (!synth) {
                    synth = createSynth(currentInstrument);
                    synth.connect(delay); 
                    synth.connect(audioAnalyzer); 
                }
                synth.volume.value = parseFloat(volumeSlider.value); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å

                if (!interactionSynth) {
                    interactionSynth = new Tone.PolySynth(Tone.Synth, { 
                        polyphony: 4, 
                        oscillator: { type: "triangle" },
                        envelope: { attack: 0.01, decay: 0.05, sustain: 0.1, release: 0.5 }
                    }).toDestination();
                    interactionSynth.volume.value = -15;
                }

                if (!mazeSynth) {
                    mazeSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: "triangle" },
                        envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.5 }
                    }).toDestination();
                    mazeSynth.volume.value = -10;
                }

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞, –µ—Å–ª–∏ –æ–Ω–∞ –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                if (!mazeSequence) {
                    mazeSequence = new Tone.Sequence((time, note) => {
                        // –°–ª—É—á–∞–π–Ω–∞—è –Ω–æ—Ç–∞ –∏–∑ mazeNotes
                        const randomNote = mazeNotes[Math.floor(Math.random() * mazeNotes.length)];
                        mazeSynth.triggerAttackRelease(randomNote, "8n", time);
                    }, mazeNotes, "8n"); // mazeNotes –∑–¥–µ—Å—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª–∏–Ω—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                    mazeSequence.loop = true;
                }

                Tone.Transport.bpm.value = parseFloat(melodyTempoSlider.value);

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ª—É–ø–∞, –µ—Å–ª–∏ –æ–Ω –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                if (!loop) {
                    loop = new Tone.Loop(time => {
                        // –ú–µ–ª–æ–¥–∏—è –∏–≥—Ä–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ "–°–≤–æ–±–æ–¥–Ω–∞—è –∏–≥—Ä–∞"
                        if (gameMode === 'free-play') {
                            const numNotesToPlay = Math.random() < 0.5 ? 1 : 2;
                            const notesToPlay = [];
                            for (let i = 0; i < numNotesToPlay; i++) {
                                notesToPlay.push(notes[Math.floor(Math.random() * notes.length)]);
                            }
                            if (synth) { 
                                synth.triggerAttackRelease(notesToPlay, "2n", time);
                                synth.volume.rampTo(parseFloat(volumeSlider.value) + (Math.random() * 5 - 2.5), 2); 
                            }
                        }

                        particlePulseFactor = 1;
                        setTimeout(() => {
                            particlePulseFactor = 0;
                        }, 100);

                    }, "4n");
                }

                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–æ–º/–æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π Tone.Transport –∏ –ª—É–ø–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
                if (gameMode === 'free-play') {
                    if (Tone.Transport.state !== 'started') {
                        Tone.Transport.start();
                    }
                    if (loop && loop.state !== 'started') {
                        loop.start(0);
                    }
                } else {
                    // –ï—Å–ª–∏ –Ω–µ —Å–≤–æ–±–æ–¥–Ω–∞—è –∏–≥—Ä–∞, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ª—É–ø
                    if (loop && loop.state === 'started') {
                        loop.stop();
                    }
                    // –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –∑–∞–ø—É—â–µ–Ω–Ω—ã–º –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä–æ–≤ (—ç—Ö–æ, –ª–∞–±–∏—Ä–∏–Ω—Ç)
                    if (Tone.Transport.state !== 'started') {
                        Tone.Transport.start();
                    }
                }

                isPlaying = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –∞—É–¥–∏–æ—Å–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞
                overlay.classList.add('hidden');
                menuToggleButton.classList.add('visible'); 
                updateGameInstructions(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∞—É–¥–∏–æ:', error);
                alert(translations[currentLanguage].audioStartError);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–º–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
        function changeInstrument(newInstrumentType) {
            // –î–∏—Å–ø–æ–∑–∏—Ü–∏—è —Å—Ç–∞—Ä–æ–≥–æ —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä–∞, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (synth && synth.dispose) {
                synth.disconnect();
                synth.dispose();
            }

            currentInstrument = newInstrumentType;
            synth = createSynth(currentInstrument); 
            
            // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä–∞ –∫ —ç—Ñ—Ñ–µ–∫—Ç–∞–º –∏ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä—É
            if (delay) {
                synth.connect(delay);
            }
            if (audioAnalyzer) {
                synth.connect(audioAnalyzer);
            }
            
            synth.volume.value = parseFloat(volumeSlider.value);

            // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ª—É–ø–∞, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω
            if (loop) {
                const wasLoopStarted = loop.state === 'started';
                loop.stop();
                loop.dispose();
                loop = null; // –û–±–Ω—É–ª—è–µ–º, —á—Ç–æ–±—ã –æ–Ω –±—ã–ª –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω
                
                loop = new Tone.Loop(time => {
                    if (gameMode === 'free-play') {
                        const numNotesToPlay = Math.random() < 0.5 ? 1 : 2;
                        const notesToPlay = [];
                        for (let i = 0; i < numNotesToPlay; i++) {
                            notesToPlay.push(notes[Math.floor(Math.random() * notes.length)]);
                        }
                        if (synth) { 
                            synth.triggerAttackRelease(notesToPlay, "2n", time);
                            synth.volume.rampTo(parseFloat(volumeSlider.value) + (Math.random() * 5 - 2.5), 2);
                        }
                    }
                    particlePulseFactor = 1;
                    setTimeout(() => { particlePulseFactor = 0; }, 100);
                }, "4n");

                if (wasLoopStarted && Tone.Transport.state === 'started') {
                    loop.start(0);
                }
            }
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–æ–≤ –∏ —Å–µ–ª–µ–∫—Ç–æ–≤ ---
        volumeSlider.addEventListener('input', (e) => {
            if (synth) {
                synth.volume.value = parseFloat(e.target.value);
            }
        });

        particleMinSizeSlider.addEventListener('input', (e) => {
            particleMinSize = parseFloat(e.target.value);
            if (particleMinSize > particleMaxSize) {
                particleMaxSizeSlider.value = particleMinSize;
                particleMaxSize = particleMinSize;
            }
        });

        particleMaxSizeSlider.addEventListener('input', (e) => {
            particleMaxSize = parseFloat(e.target.value);
            if (particleMaxSize < particleMinSize) {
                particleMinSizeSlider.value = particleMaxSize;
                particleMinSize = particleMaxSize;
            }
        });

        particleLifeSlider.addEventListener('input', (e) => {
            particleLife = parseInt(e.target.value);
        });

        particleSpeedSlider.addEventListener('input', (e) => {
            particleBaseSpeed = parseFloat(e.target.value);
        });

        particleCountSlider.addEventListener('input', (e) => {
            maxParticles = parseInt(e.target.value);
        });

        particleSpawnRateSlider.addEventListener('input', (e) => {
            particleSpawnRate = parseInt(e.target.value);
        });

        melodyTempoSlider.addEventListener('input', (e) => {
            if (Tone.Transport) {
                Tone.Transport.bpm.value = parseFloat(e.target.value);
            }
        });

        colorPaletteSelect.addEventListener('change', (e) => {
            currentColorPalette = e.target.value;
        });

        particleShapeSelect.addEventListener('change', (e) => {
            currentParticleShape = e.target.value;
        });

        particleMovementSelect.addEventListener('change', (e) => {
            currentParticleMovement = e.target.value;
        });

        instrumentSelect.addEventListener('change', (e) => {
            changeInstrument(e.target.value);
        });

        clearCanvasButton.addEventListener('click', () => {
            particles = [];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawDynamicBackground();
        });

        screenshotButton.addEventListener('click', () => {
            const dataURL = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = dataURL;
            a.download = 'zen_canvas_art.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        resetSettingsButton.addEventListener('click', () => {
            volumeSlider.value = defaultSettings.volume;
            particleMinSizeSlider.value = defaultSettings.particleMinSize;
            particleMaxSizeSlider.value = defaultSettings.particleMaxSize;
            particleLifeSlider.value = defaultSettings.particleLife;
            particleSpeedSlider.value = defaultSettings.particleSpeed;
            particleCountSlider.value = defaultSettings.particleCount;
            particleSpawnRateSlider.value = defaultSettings.particleSpawnRate;
            melodyTempoSlider.value = defaultSettings.melodyTempo;
            colorPaletteSelect.value = defaultSettings.colorPalette;
            particleShapeSelect.value = defaultSettings.particleShape;
            particleMovementSelect.value = defaultSettings.particleMovement;
            instrumentSelect.value = defaultSettings.instrument;
            gameModeSelect.value = defaultSettings.gameMode; // –°–±—Ä–æ—Å —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã
            languageSelect.value = defaultSettings.language; // –°–±—Ä–æ—Å —è–∑—ã–∫–∞

            setTheme('dark');
            themeToggleButton.textContent = translations[currentLanguage].themeButtonLight; // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏ —Ç–µ–º—ã

            gameMode = defaultSettings.gameMode; // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã
            setLanguage(defaultSettings.language); // –û–±–Ω–æ–≤–ª—è–µ–º —è–∑—ã–∫
            updateGameInstructions(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

            maxParticles = defaultSettings.particleCount;
            particleBaseSpeed = defaultSettings.particleSpeed;
            particleMinSize = defaultSettings.particleMinSize;
            particleMaxSize = defaultSettings.particleMaxSize;
            particleLife = defaultSettings.particleLife;
            particleSpawnRate = defaultSettings.particleSpawnRate;
            currentColorPalette = defaultSettings.colorPalette;
            currentParticleShape = defaultSettings.particleShape;
            currentParticleMovement = defaultSettings.particleMovement;
            
            // –î–∏—Å–ø–æ–∑–∏—Ü–∏—è –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä–æ–≤ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ
            if (synth) { synth.disconnect(); synth.dispose(); synth = null; }
            if (interactionSynth) { interactionSynth.disconnect(); interactionSynth.dispose(); interactionSynth = null; }
            if (mazeSynth) { mazeSynth.disconnect(); mazeSynth.dispose(); mazeSynth = null; }
            if (loop) { loop.stop(); loop.dispose(); loop = null; }
            if (mazeSequence) { mazeSequence.stop(); mazeSequence.dispose(); mazeSequence = null; }

            // –ó–∞–ø—É—Å–∫–∞–µ–º startAudioAndVisuals, —á—Ç–æ–±—ã –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ—Å–∏—Å—Ç–µ–º—É
            // —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –∞–∫—Ç–∏–≤–Ω–∞.
            isPlaying = false; // –°–±—Ä–æ—Å —Ñ–ª–∞–≥–∞, —á—Ç–æ–±—ã startAudioAndVisuals –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—å
            startAudioAndVisuals(); // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∞—É–¥–∏–æ—Å–∏—Å—Ç–µ–º—É

            isMazePlayingAudio = false;
            activeEchoSynthNote = null;

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –ª–∞–±–∏—Ä–∏–Ω—Ç –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            if (gameMode === 'melody-maze') {
                generateRandomMazePath();
            }

            bgHue1 = 0;
            bgHue2 = 180;

            clearCanvasButton.click();
        });


        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é (—Ä–∞–Ω–µ–µ toggleControlsButton) ---
        menuToggleButton.addEventListener('click', () => {
            const isPanelVisible = controlsPanel.classList.contains('visible');
            if (isPanelVisible) {
                controlsPanel.classList.remove('visible');
                menuBackdrop.classList.remove('visible');
                menuToggleButton.textContent = translations[currentLanguage].menuButtonOpen;
            } else {
                controlsPanel.classList.add('visible');
                menuBackdrop.classList.add('visible');
                menuToggleButton.textContent = translations[currentLanguage].menuButtonClose; 
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –±—ç–∫–¥—Ä–æ–ø–∞ (–∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ)
        menuBackdrop.addEventListener('click', () => {
            controlsPanel.classList.remove('visible');
            menuBackdrop.classList.remove('visible');
            menuToggleButton.textContent = translations[currentLanguage].menuButtonOpen;
        });

        // --- –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã ---
        function setTheme(theme) {
            currentTheme = theme;
            document.body.classList.toggle('light-theme', theme === 'light');
            canvas.style.backgroundColor = theme === 'light' ? '#e0e0e0' : '#000';
            ctx.fillStyle = theme === 'light' ? 'rgba(255, 255, 255, 0.03)' : 'rgba(0, 0, 0, 0.03)';
            localStorage.setItem('zenTheme', theme);
        }

        themeToggleButton.addEventListener('click', () => {
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
            themeToggleButton.textContent = newTheme === 'dark' ? translations[currentLanguage].themeButtonLight : translations[currentLanguage].themeButtonDark;
        });

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã ---
        gameModeSelect.addEventListener('change', (e) => {
            gameMode = e.target.value;
            updateGameInstructions(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
            particles = []; // –û—á–∏—â–∞–µ–º —á–∞—Å—Ç–∏—Ü—ã –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞

            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∞—É–¥–∏–æ-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
            if (loop && loop.state === 'started') {
                loop.stop();
            }
            if (mazeSequence && mazeSequence.state === 'started') {
                mazeSequence.stop();
                isMazePlayingAudio = false;
            }
            if (activeEchoSynthNote) {
                interactionSynth.triggerRelease(activeEchoSynthNote, Tone.now());
                activeEchoSynthNote = null;
            }

            // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ Tone.Transport –∑–∞–ø—É—â–µ–Ω, –µ—Å–ª–∏ –º—ã –≤ –ª—é–±–æ–º –∞—É–¥–∏–æ-—Ä–µ–∂–∏–º–µ
            if (Tone.Transport.state !== 'started') {
                Tone.Transport.start();
            }

            // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ª—É–ø, –µ—Å–ª–∏ –ø–µ—Ä–µ—à–ª–∏ –≤ —Ä–µ–∂–∏–º "–°–≤–æ–±–æ–¥–Ω–∞—è –∏–≥—Ä–∞"
            if (gameMode === 'free-play') {
                if (loop) loop.start(0);
            }

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –ª–∞–±–∏—Ä–∏–Ω—Ç, –µ—Å–ª–∏ –ø–µ—Ä–µ—à–ª–∏ –≤ —Ä–µ–∂–∏–º "–ú–µ–ª–æ–¥–∏—á–Ω—ã–π –ª–∞–±–∏—Ä–∏–Ω—Ç"
            if (gameMode === 'melody-maze') {
                generateRandomMazePath();
            }
        });

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–º–µ–Ω—ã —è–∑—ã–∫–∞ ---
        languageSelect.addEventListener('change', (e) => {
            setLanguage(e.target.value);
        });

        // --- –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ ---
        document.addEventListener('keydown', (e) => {
            if (e.key === 'c' || e.key === 'C') {
                clearCanvasButton.click();
            }
            if (e.key === 's' || e.key === 'S') {
                screenshotButton.click();
            }
            if (e.key === 'r' || e.key === 'R') {
                resetSettingsButton.click();
            }
            // "T" - –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –º–µ–Ω—é
            if (e.key === 't' || e.key === 'T') {
                menuToggleButton.click();
            }
            // "L" - –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É (Light/Dark)
            if (e.key === 'l' || e.key === 'L') {
                themeToggleButton.click();
            }
        });


        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è (–æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è —Ä–µ–∂–∏–º–æ–≤ –∏–≥—Ä—ã) ---
        canvas.addEventListener('mousemove', (e) => {
            if (!isPlaying) return;
            if (gameMode === 'free-play') {
                for (let i = 0; i < particleSpawnRate; i++) {
                    createParticle(e.clientX, e.clientY);
                }
            } else if (gameMode === 'melody-maze') {
                const mousePos = { x: e.clientX, y: e.clientY };
                let onPath = false;

                for (let i = 0; i < currentMazePath.length - 1; i++) {
                    const p1 = currentMazePath[i];
                    const p2 = currentMazePath[i+1];
                    const distance = distToSegment(mousePos, p1, p2);
                    if (distance < mazeLineTolerance) {
                        onPath = true;
                        break;
                    }
                }

                if (onPath) {
                    if (!isMazePlayingAudio) {
                        // Tone.Transport —É–∂–µ –∑–∞–ø—É—â–µ–Ω –≤ gameModeSelect change
                        mazeSequence.start(Tone.now());
                        isMazePlayingAudio = true;
                    }
                    // Generate particles along the path
                    for (let i = 0; i < particleSpawnRate / 2; i++) { // Fewer particles to avoid clutter
                        createParticle(e.clientX, e.clientY);
                    }
                } else {
                    if (isMazePlayingAudio) {
                        mazeSequence.stop();
                        isMazePlayingAudio = false;
                    }
                }
            }
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!isPlaying) return;
            if (gameMode === 'free-play') {
                for (let i = 0; i < e.touches.length; i++) {
                    for (let j = 0; j < particleSpawnRate; j++) {
                        createParticle(e.touches[i].clientX, e.touches[i].clientY);
                    }
                }
            } else if (gameMode === 'melody-maze') {
                const touchPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                let onPath = false;

                for (let i = 0; i < currentMazePath.length - 1; i++) {
                    const p1 = currentMazePath[i];
                    const p2 = currentMazePath[i+1];
                    const distance = distToSegment(touchPos, p1, p2);
                    if (distance < mazeLineTolerance) {
                        onPath = true;
                        break;
                    }
                }

                if (onPath) {
                    if (!isMazePlayingAudio) {
                        // Tone.Transport —É–∂–µ –∑–∞–ø—É—â–µ–Ω –≤ gameModeSelect change
                        mazeSequence.start(Tone.now());
                        isMazePlayingAudio = true;
                    }
                    for (let i = 0; i < particleSpawnRate / 2; i++) {
                        createParticle(e.touches[0].clientX, e.touches[0].clientY);
                    }
                } else {
                    if (isMazePlayingAudio) {
                        mazeSequence.stop();
                        isMazePlayingAudio = false;
                    }
                }
            }
        }, { passive: false });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ mousedown/mouseup –¥–ª—è —Ä–µ–∂–∏–º–∞ "–≠—Ö–æ-—Å—Ñ–µ—Ä–∞"
        canvas.addEventListener('mousedown', (e) => {
            if (!isPlaying) return;
            if (gameMode === 'echo-sphere') {
                if (activeEchoSynthNote) { // –ï—Å–ª–∏ –Ω–æ—Ç–∞ —É–∂–µ —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, –æ—Ç–ø—É—Å–∫–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é
                    interactionSynth.triggerRelease(activeEchoSynthNote, Tone.now());
                }
                const normalizedY = e.clientY / canvas.height;
                const minFreq = Tone.Midi('C3').toFrequency();
                const maxFreq = Tone.Midi('C6').toFrequency();
                const frequency = minFreq + (maxFreq - minFreq) * (1 - normalizedY);
                activeEchoSynthNote = frequency;
                interactionSynth.triggerAttack(frequency, Tone.now());
                // –°–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π "–≤—Å–ø–ª–µ—Å–∫" —á–∞—Å—Ç–∏—Ü –¥–ª—è —Å—Ñ–µ—Ä—ã
                for (let i = 0; i < 20; i++) { 
                    createParticle(e.clientX, e.clientY);
                }
            } else if (gameMode === 'melody-maze') {
                // –í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ mousedown/mouseup –Ω–µ —É–ø—Ä–∞–≤–ª—è—é—Ç –∞—É–¥–∏–æ –Ω–∞–ø—Ä—è–º—É—é,
                // —Ç–æ–ª—å–∫–æ mousemove/touchmove. –û–¥–Ω–∞–∫–æ, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–Ω—É–ª –≤–Ω–µ –ø—É—Ç–∏,
                // –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∞—É–¥–∏–æ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–æ—Å—å.
                const mousePos = { x: e.clientX, y: e.clientY };
                let onPath = false;
                for (let i = 0; i < currentMazePath.length - 1; i++) {
                    const p1 = currentMazePath[i];
                    const p2 = currentMazePath[i+1];
                    const distance = distToSegment(mousePos, p1, p2);
                    if (distance < mazeLineTolerance) {
                        onPath = true;
                        break;
                    }
                }
                if (!onPath && isMazePlayingAudio) {
                    mazeSequence.stop();
                    isMazePlayingAudio = false;
                }
            }
        });

        canvas.addEventListener('mouseup', (e) => {
            if (gameMode === 'echo-sphere') {
                if (activeEchoSynthNote) {
                    interactionSynth.triggerRelease(activeEchoSynthNote, Tone.now());
                    activeEchoSynthNote = null;
                }
            } else if (gameMode === 'melody-maze') {
                // –ü—Ä–∏ –æ—Ç–ø—É—Å–∫–∞–Ω–∏–∏ –∫–Ω–æ–ø–∫–∏ –º—ã—à–∏ –≤ —Ä–µ–∂–∏–º–µ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–≤—É–∫ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞
                if (isMazePlayingAudio) {
                    mazeSequence.stop();
                    isMazePlayingAudio = false;
                }
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ touchstart/touchend –¥–ª—è —Ä–µ–∂–∏–º–∞ "–≠—Ö–æ-—Å—Ñ–µ—Ä–∞"
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (!isPlaying) return;
            if (gameMode === 'echo-sphere') {
                if (activeEchoSynthNote) {
                    interactionSynth.triggerRelease(activeEchoSynthNote, Tone.now());
                }
                const normalizedY = e.touches[0].clientY / canvas.height;
                const minFreq = Tone.Midi('C3').toFrequency();
                const maxFreq = Tone.Midi('C6').toFrequency();
                const frequency = minFreq + (maxFreq - minFreq) * (1 - normalizedY);
                activeEchoSynthNote = frequency;
                interactionSynth.triggerAttack(frequency, Tone.now());
                for (let i = 0; i < 20; i++) {
                    createParticle(e.touches[0].clientX, e.touches[0].clientY);
                }
            } else if (gameMode === 'melody-maze') {
                const touchPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                let onPath = false;
                for (let i = 0; i < currentMazePath.length - 1; i++) {
                    const p1 = currentMazePath[i];
                    const p2 = currentMazePath[i+1];
                    const distance = distToSegment(touchPos, p1, p2);
                    if (distance < mazeLineTolerance) {
                        onPath = true;
                        break;
                    }
                }
                if (!onPath && isMazePlayingAudio) {
                    mazeSequence.stop();
                    isMazePlayingAudio = false;
                }
            }
        }, { passive: false });

        canvas.addEventListener('touchend', (e) => {
            if (gameMode === 'echo-sphere') {
                if (activeEchoSynthNote) {
                    interactionSynth.triggerRelease(activeEchoSynthNote, Tone.now());
                    activeEchoSynthNote = null;
                }
            } else if (gameMode === 'melody-maze') {
                // –ü—Ä–∏ –æ—Ç–ø—É—Å–∫–∞–Ω–∏–∏ –ø–∞–ª—å—Ü–∞ –≤ —Ä–µ–∂–∏–º–µ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–≤—É–∫ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞
                if (isMazePlayingAudio) {
                    mazeSequence.stop();
                    isMazePlayingAudio = false;
                }
            }
        }, { passive: false });


        // --- –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —á–∞—Å—Ç–∏—Ü –∏ —Ñ–æ–Ω–∞ ---
        function animateParticles() {
            drawDynamicBackground();

            ctx.fillStyle = currentTheme === 'light' ? 'rgba(255, 255, 255, 0.03)' : 'rgba(0, 0, 0, 0.03)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—É—Ç–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞
            if (gameMode === 'melody-maze' && currentMazePath.length > 1) {
                ctx.beginPath();
                ctx.moveTo(currentMazePath[0].x, currentMazePath[0].y);
                for (let i = 1; i < currentMazePath.length; i++) {
                    ctx.lineTo(currentMazePath[i].x, currentMazePath[i].y);
                }
                ctx.strokeStyle = 'rgba(100, 200, 255, 0.6)'; // –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Å–∏–Ω–∏–π
                ctx.lineWidth = 15; // –¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏
                ctx.lineCap = 'round'; // –°–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ü—ã –ª–∏–Ω–∏–∏
                ctx.lineJoin = 'round'; // –°–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                ctx.stroke();
            }

            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                
                // –õ–æ–≥–∏–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è —á–∞—Å—Ç–∏—Ü –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã
                if (gameMode === 'echo-sphere') {
                    const elapsed = Tone.now() - p.spawnTime;
                    // –†–∞–¥–∏–∞–ª—å–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –æ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏
                    const currentDistance = elapsed * particleBaseSpeed * 10; 
                    p.x = p.initialX + Math.cos(p.angle) * currentDistance;
                    p.y = p.initialY + Math.sin(p.angle) * currentDistance;
                    p.alpha -= 1 / p.life; 
                } else {
                    // –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è –¥–ª—è —Å–≤–æ–±–æ–¥–Ω–æ–π –∏–≥—Ä—ã –∏ –º–µ–ª–æ–¥–∏—á–Ω–æ–≥–æ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞
                    if (currentParticleMovement === 'spiral') {
                        const angle = Math.atan2(p.y - canvas.height / 2, p.x - canvas.width / 2);
                        const distance = Math.sqrt(Math.pow(p.x - canvas.width / 2, 2) + Math.pow(p.y - canvas.height / 2, 2));
                        p.speedX = Math.cos(angle + Math.PI / 2) * (particleBaseSpeed * 0.5) + (p.x - canvas.width / 2) * 0.001;
                        p.speedY = Math.sin(angle + Math.PI / 2) * (particleBaseSpeed * 0.5) + (p.y - canvas.height / 2) * 0.001;
                    } else if (currentParticleMovement === 'wave') {
                        p.speedX = Math.sin(p.x * 0.05 + hue * 0.01) * particleBaseSpeed * 0.8;
                        p.speedY = Math.cos(p.y * 0.05 + hue * 0.01) * particleBaseSpeed * 0.8;
                    }
                    p.x += p.speedX;
                    p.y += p.speedY;
                    p.alpha -= 1 / p.life;
                }

                if (p.alpha <= 0 || p.life <= 0 || 
                    p.x < -p.radius || p.x > canvas.width + p.radius || 
                    p.y < -p.radius || p.y > canvas.height + p.radius) {
                    particles.splice(i, 1);
                    continue;
                }

                drawParticle(p);
            }

            while (particles.length > maxParticles) {
                particles.shift();
            }

            if (currentColorPalette === 'dynamic') {
                hue = (hue + 0.3) % 360;
            }

            requestAnimationFrame(animateParticles);
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É "–°—Ç–∞—Ä—Ç"
        startButton.addEventListener('click', startAudioAndVisuals);

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —á–∞—Å—Ç–∏—Ü –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞—É–¥–∏–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = async function() { 
            const savedTheme = localStorage.getItem('zenTheme');
            if (savedTheme) {
                setTheme(savedTheme);
                themeToggleButton.textContent = translations[currentLanguage].themeButtonLight; // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Ç–µ–º—ã
            } else {
                setTheme(defaultSettings.theme);
                themeToggleButton.textContent = translations[currentLanguage].themeButtonLight;
            }

            const savedLanguage = localStorage.getItem('zenLanguage');
            if (savedLanguage && translations[savedLanguage]) {
                languageSelect.value = savedLanguage;
                setLanguage(savedLanguage);
            } else {
                languageSelect.value = defaultSettings.language;
                setLanguage(defaultSettings.language);
            }


            bgHue1 = Math.random() * 360;
            bgHue2 = (bgHue1 + 180) % 360;

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–∞–±–∏—Ä–∏–Ω—Ç –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞–∑–º–µ—Ä–æ–≤ —Ö–æ–ª—Å—Ç–∞
            resizeCanvas(); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã —Ö–æ–ª—Å—Ç–∞
            generateRandomMazePath(); // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π –ª–∞–±–∏—Ä–∏–Ω—Ç

            animateParticles();
            updateGameInstructions();
        };
    
    let mediaRecorder;
    let recordedChunks = [];

    const recordButton = document.createElement('button');
    recordButton.id = "recordButton";
    recordButton.className = "action-button";
    recordButton.style.background = "linear-gradient(145deg, #f56565, #c53030)";
    recordButton.textContent = translations[currentLanguage].recordStart;
    controlsPanel.appendChild(recordButton);

    recordButton.addEventListener('click', () => {
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            startRecording();
            recordButton.textContent = translations[currentLanguage].recordStop;
        } else if (mediaRecorder.state === "recording") {
            stopRecording();
            recordButton.textContent = translations[currentLanguage].recordStart;
        }
    });

    function startRecording() {
        const stream = canvas.captureStream(30);
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });

        mediaRecorder.ondataavailable = e => {
            if (e.data.size > 0) recordedChunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'zen-canvas-recording.webm';
            a.click();
            URL.revokeObjectURL(url);
            recordedChunks = [];
        };

        mediaRecorder.start();
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
        }
    }

</script>
    </script>
    <script>
    let mediaRecorder;
    let recordedChunks = [];

    // –ö–Ω–æ–ø–∫–∞ –∑–∞–ø–∏—Å–∏
    const recordButton = document.createElement('button');
recordButton.id = "recordButton";
recordButton.className = "action-button";
recordButton.style.background = "linear-gradient(145deg, #f56565, #c53030)";
recordButton.textContent = translations[currentLanguage].recordStart; // üîÅ –ø–µ—Ä–µ–≤–æ–¥
document.getElementById("controlsPanel").appendChild(recordButton);

recordButton.addEventListener('click', async () => {
    if (!mediaRecorder || mediaRecorder.state === "inactive") {
        await startRecording();
        recordButton.textContent = translations[currentLanguage].recordStop; // üîÅ –ø–µ—Ä–µ–≤–æ–¥
    } else if (mediaRecorder.state === "recording") {
        stopRecording();
        recordButton.textContent = translations[currentLanguage].recordStart; // üîÅ –ø–µ—Ä–µ–≤–æ–¥
    }
});


    async function startRecording() {
        const canvas = document.getElementById('artCanvas');
        const canvasStream = canvas.captureStream(60); // 60 FPS

        // –ü–æ–ª—É—á–∞–µ–º –∞—É–¥–∏–æ–≤—ã—Ö–æ–¥ –æ—Ç Tone.js
        const audioCtx = Tone.context.rawContext;
        const audioDestination = audioCtx.createMediaStreamDestination();

        // –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∞—É–¥–∏–æ–≤—ã—Ö–æ–¥ –∫ –ø–æ—Ç–æ–∫—É
        Tone.getDestination().connect(audioDestination);

        // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤–∏–¥–µ–æ –∏ –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫–∏
        const combinedStream = new MediaStream([
            ...canvasStream.getVideoTracks(),
            ...audioDestination.stream.getAudioTracks()
        ]);

        mediaRecorder = new MediaRecorder(combinedStream, {
            mimeType: 'video/webm; codecs=vp9,opus'
        });

        mediaRecorder.ondataavailable = e => {
            if (e.data.size > 0) recordedChunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'zen-recording.webm';
            a.click();
            URL.revokeObjectURL(url);
            recordedChunks = [];
        };

        mediaRecorder.start();
        console.log("üî¥ –ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å (60 FPS + –∑–≤—É–∫ –∏–∑ Tone.js)");
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
            console.log("üü¢ –ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");
        }
    }
</script>


</body>
</html>
